# ๐ ะฃัะพะบ 04: ะะฟัะธัะตัะบะธะต ัะฝะบะพะดะตัั ะธ ะธะทะผะตัะตะฝะธะต ัะบะพัะพััะธ ะผะพัะพัะพะฒ

## ๐ฏ ะฆะตะปั ััะพะบะฐ

ะะฐััะธัััั ะฟะพะดะบะปััะฐัั ะพะฟัะธัะตัะบะธะต ัะฝะบะพะดะตัั ะบ Black Pill ะธ ะธะทะผะตัััั ัะบะพัะพััั ะฒัะฐัะตะฝะธั (RPM) ะผะพัะพัะพะฒ ั ะฟะพะผะพััั ะฟัะตััะฒะฐะฝะธะน EXTI.

## ๐ ะงัะพ ะฒั ัะทะฝะฐะตัะต

1. โ ะะฐะบ ัะฐะฑะพัะฐะตั ะพะฟัะธัะตัะบะธะน ัะตะปะตะฒะพะน ะดะฐััะธะบ
2. โ ะงัะพ ัะฐะบะพะต ะดะธัะบ ัะฝะบะพะดะตัะฐ ั ะฟัะพัะตะทัะผะธ
3. โ ะะฐะบ ะฟะพะดะบะปััะธัั 4 ัะฝะบะพะดะตัะฐ ะบ Black Pill
4. โ ะะฐะบ ะฝะฐัััะพะธัั ะฒะฝะตัะฝะธะต ะฟัะตััะฒะฐะฝะธั (EXTI)
5. โ ะะฐะบ ััะธัะฐัั ะธะผะฟัะปััั ะธ ะฒััะธัะปะธัั RPM
6. โ ะะฐะบ ะธัะฟะพะปัะทะพะฒะฐัั ัะฝะบะพะดะตัั ะดะปั ะพะฑัะฐัะฝะพะน ัะฒัะทะธ

---

## ๐ฌ ะงัะพ ัะฐะบะพะต ะพะฟัะธัะตัะบะธะน ัะฝะบะพะดะตั?

### ะัะธะฝัะธะฟ ัะฐะฑะพัั

```
ะกะฒะตั ะฟัะพัะพะดะธั        ะกะฒะตั ะฑะปะพะบะธััะตััั
ัะตัะตะท ะฟัะพัะตะท         ะดะธัะบะพะผ
    โ                      โ
โโโโโโโโโโ            โโโโโโโโโโ
โ   IR   โ            โ   IR   โ
โ  LED   โโโโโธโ       โ  LED   โโโโโธโ
โโโโโโโโโโ    โ       โโโโโโโโโโ    โ
            โ                     โ
        โโโโโโดโโโโโ           โโโโโโดโโโโโ
        โ Photo-  โ           โ Photo-  โ
        โ trans.  โ           โ trans.  โ
        โโโโโโโโโโโ           โโโโโโโโโโโ
            โ                      โ
        OUT = HIGH           OUT = LOW
```

**ะะพะณะดะฐ ะดะธัะบ ะฒัะฐัะฐะตััั:**

- ะัะพัะตะท โ ะกะฒะตั ะฟัะพัะพะดะธั โ ะขัะฐะฝะทะธััะพั ะพัะบััั โ OUT = HIGH
- ะะฐัะตัะธะฐะป ะดะธัะบะฐ โ ะกะฒะตั ะฑะปะพะบะธััะตััั โ ะขัะฐะฝะทะธััะพั ะทะฐะบััั โ OUT = LOW
- ะะตะทัะปััะฐั: **ะฆะธััะพะฒัะต ะธะผะฟัะปััั** ะฟัะธ ะฒัะฐัะตะฝะธะธ

---

## ๐๏ธ ะะพะผะฟะพะฝะตะฝัั

### 1. ะะฟัะธัะตัะบะธะน ัะตะปะตะฒะพะน ะดะฐััะธะบ (DAT233)

**ะฅะฐัะฐะบัะตัะธััะธะบะธ:**

- ะะฐะฟััะถะตะฝะธะต: 3.3V - 5V
- ะจะธัะธะฝะฐ ะฟัะพัะตะทะฐ: 6 ะผะผ
- ะััะพะดั: ะะฝะฐะปะพะณะพะฒัะน + ะฆะธััะพะฒะพะน
- ะะพะผะฟะฐัะฐัะพั: ะัััะพะตะฝะฝัะน (ะบััััะต ััะพะฝัั ัะธะณะฝะฐะปะฐ)
- ะะฝะดะธะบะฐัะพั: LED ะฟะพะบะฐะทัะฒะฐะตั ัะพััะพัะฝะธะต ะฒััะพะดะฐ
- ะะฐะทะผะตัั: ะะพะผะฟะฐะบัะฝัะน

**ะะฐะทะฝะฐัะตะฝะธะต ะฒัะฒะพะดะพะฒ:**

```
โโโโโโโโโโโโโโโโ
โ   ะะฐััะธะบ     โ
โ   DAT233     โ
โ              โ
โ GND VCC OUT  โ
โโโโฌโโโโฌโโโโฌโโโโ
   โ   โ   โ
  GND 3V3 Pin (EXTI)
```

**ะกััะปะบะฐ:** <https://arduino.ua/prod2290-opticheskii-datchik-prepyatstviya-kompaktnii>

### 2. ะะธัะบ ั 20 ะฟัะพัะตะทะฐะผะธ

**ะฅะฐัะฐะบัะตัะธััะธะบะธ:**

- ะะฐัะตัะธะฐะป: ะงะตัะฝัะน ะพัะณััะตะบะปะพ (ะฝะตะฟัะพะทัะฐัะฝะพะต)
- ะะธะฐะผะตัั: 27 ะผะผ
- ะขะพะปัะธะฝะฐ: 3 ะผะผ
- ะะพะปะธัะตััะฒะพ ะฟัะพัะตะทะพะฒ: 20
- ะะฐะทัะตัะตะฝะธะต: 18ยฐ ะฝะฐ ะฟัะพัะตะท (360ยฐ / 20)

**ะะพะฝัะฐะถ:**

- ะฆะตะฝััะฐะปัะฝะพะต ะพัะฒะตัััะธะต ะดะปั ะพัะธ ะผะพัะพัะฐ
- ะัะตะฟะปะตะฝะธะต: ะฒะธะฝั ะธะปะธ ะบะปะตะน
- ะะฐะถะฝะพ: ะฑะตะท ะฒะธะฑัะฐัะธะน!

**ะกััะปะบะฐ:** <https://arduino.ua/prod4271-disk-s-prorezyami-dlya-opticheskogo-enkodera>

---

## ๐ ะกัะตะผะฐ ะฟะพะดะบะปััะตะฝะธั

### ะะพะดะบะปััะตะฝะธะต 4 ัะฝะบะพะดะตัะพะฒ ะบ Black Pill

| ะญะฝะบะพะดะตั | ะะพัะพั | Black Pill Pin | EXTI ะปะธะฝะธั | ะคัะฝะบัะธั |
|---------|-------|----------------|------------|---------|
| ENC0 | Motor 0 | **B6** | EXTI6 | ะัะตััะฒะฐะฝะธะต |
| ENC1 | Motor 1 | **B7** | EXTI7 | ะัะตััะฒะฐะฝะธะต |
| ENC2 | Motor 2 | **A2** | EXTI2 | ะัะตััะฒะฐะฝะธะต |
| ENC3 | Motor 3 | **A3** | EXTI3 | ะัะตััะฒะฐะฝะธะต |

**ะะธัะฐะฝะธะต (ะดะปั ะฒัะตั 4 ะดะฐััะธะบะพะฒ):**

- VCC โ 3V3
- GND โ GND

### ะคะธะทะธัะตัะบะพะต ัะฐัะฟะพะปะพะถะตะฝะธะต

```
  Motor 0          Motor 1
    โโดโ             โโดโ
    โโโ             โโโ
    โโฌโ             โโฌโ
    โ Encoder       โ Encoder
    โ Disk          โ Disk
    โผ               โผ
  โโโโโโโ         โโโโโโโ
  โ O O โ         โ O O โ  โ Optical sensors
  โโโโฌโโโ         โโโโฌโโโ
    โ               โ
    B6              B7
    โ               โ
    โโโโโโโโโฌโโโโโโโโ
           โ
     โโโโโโโโดโโโโโโโ
     โ Black Pill  โ
     โ             โ
     โ  A2    A3   โ
     โโโโโฌโโโโโฌโโโโโ
        โ    โ
     โโโโโดโ โโดโโโโ
     โ O Oโ โO O โ  โ Optical sensors
     โโโโโโโ โโโโโโ
        โฒ       โฒ
        โ       โ Encoder
        โ       โ Disk
       โโดโ     โโดโ
       โโโ     โโโ
       โโโ     โโโ
    Motor 2   Motor 3
```

---

## ๐ป ะะพะด ะดัะฐะนะฒะตัะฐ ัะฝะบะพะดะตัะฐ

### 1. ะกะพะทะดะฐะนัะต ัะฐะนะป `src/encoder.h`

```c
/**
 * @file    encoder.h
 * @brief   Optical encoder driver for 4 motors
 */

#ifndef ENCODER_H
#define ENCODER_H

#include "main.h"
#include <stdint.h>
#include <stdbool.h>

// ะะพะปะธัะตััะฒะพ ะฟัะพัะตะทะพะฒ ะฝะฐ ะดะธัะบะต
#define ENCODER_SLOTS_PER_REV   20

// ะะดะตะฝัะธัะธะบะฐัะพัั ัะฝะบะพะดะตัะพะฒ
typedef enum {
    ENCODER_0 = 0,  // Motor 0 - PB6
    ENCODER_1 = 1,  // Motor 1 - PB7
    ENCODER_2 = 2,  // Motor 2 - PA2
    ENCODER_3 = 3,  // Motor 3 - PA3
    ENCODER_COUNT = 4
} Encoder_ID;

// ะัะฑะปะธัะฝัะต ััะฝะบัะธะธ
void Encoder_Init(void);
void Encoder_ResetCount(Encoder_ID encoder);
uint32_t Encoder_GetCount(Encoder_ID encoder);
float Encoder_GetRPM(Encoder_ID encoder);
void Encoder_Update(void);  // ะัะทัะฒะฐัั ะบะฐะถะดัะต 100ะผั

#endif /* ENCODER_H */
```

### 2. ะกะพะทะดะฐะนัะต ัะฐะนะป `src/encoder.c`

```c
/**
 * @file    encoder.c
 * @brief   Optical encoder implementation
 */

#include "encoder.h"

// ะกัะตััะธะบะธ ะธะผะฟัะปััะพะฒ
static volatile uint32_t pulse_count[ENCODER_COUNT] = {0, 0, 0, 0};
static volatile uint32_t last_count[ENCODER_COUNT] = {0, 0, 0, 0};
static volatile uint32_t last_time[ENCODER_COUNT] = {0, 0, 0, 0};
static float rpm[ENCODER_COUNT] = {0.0f, 0.0f, 0.0f, 0.0f};

/**
 * @brief ะะฝะธัะธะฐะปะธะทะฐัะธั ะฒัะตั ัะฝะบะพะดะตัะพะฒ
 */
void Encoder_Init(void) {
    GPIO_InitTypeDef GPIO_InitStruct = {0};

    // ะะบะปััะธัั ัะฐะบัะธัะพะฒะฐะฝะธะต GPIO
    __HAL_RCC_GPIOA_CLK_ENABLE();
    __HAL_RCC_GPIOB_CLK_ENABLE();

    // ะะฐัััะพะนะบะฐ GPIO ะบะฐะบ ะฒัะพะดะฐ ั ะฟัะตััะฒะฐะฝะธะตะผ ะฟะพ ัะฐััััะตะผั ััะพะฝัั
    GPIO_InitStruct.Mode = GPIO_MODE_IT_RISING;
    GPIO_InitStruct.Pull = GPIO_PULLDOWN;
    GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_HIGH;

    // Encoder 0 - PB6
    GPIO_InitStruct.Pin = GPIO_PIN_6;
    HAL_GPIO_Init(GPIOB, &GPIO_InitStruct);

    // Encoder 1 - PB7
    GPIO_InitStruct.Pin = GPIO_PIN_7;
    HAL_GPIO_Init(GPIOB, &GPIO_InitStruct);

    // Encoder 2 - PA2
    GPIO_InitStruct.Pin = GPIO_PIN_2;
    HAL_GPIO_Init(GPIOA, &GPIO_InitStruct);

    // Encoder 3 - PA3
    GPIO_InitStruct.Pin = GPIO_PIN_3;
    HAL_GPIO_Init(GPIOA, &GPIO_InitStruct);

    // ะะบะปััะธัั ะฟัะตััะฒะฐะฝะธั
    HAL_NVIC_SetPriority(EXTI2_IRQn, 5, 0);
    HAL_NVIC_EnableIRQ(EXTI2_IRQn);

    HAL_NVIC_SetPriority(EXTI3_IRQn, 5, 0);
    HAL_NVIC_EnableIRQ(EXTI3_IRQn);

    HAL_NVIC_SetPriority(EXTI9_5_IRQn, 5, 0);
    HAL_NVIC_EnableIRQ(EXTI9_5_IRQn);
}

/**
 * @brief ะกะฑัะพัะธัั ััะตััะธะบ ะธะผะฟัะปััะพะฒ
 */
void Encoder_ResetCount(Encoder_ID encoder) {
    if (encoder < ENCODER_COUNT) {
       pulse_count[encoder] = 0;
       last_count[encoder] = 0;
       rpm[encoder] = 0.0f;
    }
}

/**
 * @brief ะะพะปััะธัั ะพะฑัะตะต ะบะพะปะธัะตััะฒะพ ะธะผะฟัะปััะพะฒ
 */
uint32_t Encoder_GetCount(Encoder_ID encoder) {
    if (encoder < ENCODER_COUNT) {
       return pulse_count[encoder];
    }
    return 0;
}

/**
 * @brief ะะพะปััะธัั ัะตะบััะธะน RPM
 */
float Encoder_GetRPM(Encoder_ID encoder) {
    if (encoder < ENCODER_COUNT) {
       return rpm[encoder];
    }
    return 0.0f;
}

/**
 * @brief ะะฑะฝะพะฒะธัั ัะฐััะตั RPM (ะฒัะทัะฒะฐัั ะบะฐะถะดัะต 100ะผั)
 */
void Encoder_Update(void) {
    uint32_t current_time = HAL_GetTick();

    for (uint8_t i = 0; i < ENCODER_COUNT; i++) {
       // ะะพะปะธัะตััะฒะพ ะธะผะฟัะปััะพะฒ ะทะฐ ะฟัะพะผะตะถััะพะบ ะฒัะตะผะตะฝะธ
       uint32_t pulses = pulse_count[i] - last_count[i];
       uint32_t time_diff = current_time - last_time[i];

       if (time_diff > 0) {
          // RPM = (ะธะผะฟัะปััั * 60000 ะผั) / (ะฒัะตะผั_ะผั * ะฟัะพัะตะทั_ะฝะฐ_ะพะฑะตัั)
          rpm[i] = (pulses * 60000.0f) / (time_diff * ENCODER_SLOTS_PER_REV);
       }

       // ะัะปะธ ะดะพะปะณะพ ะฝะตั ะธะผะฟัะปััะพะฒ - ะผะพัะพั ะพััะฐะฝะพะฒะธะปัั
       if (time_diff > 500) {  // 500ะผั ะฑะตะท ะธะผะฟัะปััะพะฒ
          rpm[i] = 0.0f;
       }

       last_count[i] = pulse_count[i];
       last_time[i] = current_time;
    }
}

/**
 * @brief ะะฑัะฐะฑะพััะธะบ ะฟัะตััะฒะฐะฝะธั ะดะปั PB6 ะธ PB7
 */
void EXTI9_5_IRQHandler(void) {
    // Encoder 0 - PB6
    if (__HAL_GPIO_EXTI_GET_IT(GPIO_PIN_6) != RESET) {
       __HAL_GPIO_EXTI_CLEAR_IT(GPIO_PIN_6);
       pulse_count[ENCODER_0]++;
    }

    // Encoder 1 - PB7
    if (__HAL_GPIO_EXTI_GET_IT(GPIO_PIN_7) != RESET) {
       __HAL_GPIO_EXTI_CLEAR_IT(GPIO_PIN_7);
       pulse_count[ENCODER_1]++;
    }
}

/**
 * @brief ะะฑัะฐะฑะพััะธะบ ะฟัะตััะฒะฐะฝะธั ะดะปั PA2
 */
void EXTI2_IRQHandler(void) {
    if (__HAL_GPIO_EXTI_GET_IT(GPIO_PIN_2) != RESET) {
       __HAL_GPIO_EXTI_CLEAR_IT(GPIO_PIN_2);
       pulse_count[ENCODER_2]++;
    }
}

/**
 * @brief ะะฑัะฐะฑะพััะธะบ ะฟัะตััะฒะฐะฝะธั ะดะปั PA3
 */
void EXTI3_IRQHandler(void) {
    if (__HAL_GPIO_EXTI_GET_IT(GPIO_PIN_3) != RESET) {
       __HAL_GPIO_EXTI_CLEAR_IT(GPIO_PIN_3);
       pulse_count[ENCODER_3]++;
    }
}
```

### 3. ะัะธะผะตั ะธัะฟะพะปัะทะพะฒะฐะฝะธั ะฒ `main.c`

```c
#include "main.h"
#include "encoder.h"
#include <stdio.h>

void SystemClock_Config(void);

int main(void) {
    // ะะฝะธัะธะฐะปะธะทะฐัะธั HAL
    HAL_Init();
    SystemClock_Config();

    // ะะฝะธัะธะฐะปะธะทะฐัะธั LED ะดะปั ะธะฝะดะธะบะฐัะธะธ
    __HAL_RCC_GPIOC_CLK_ENABLE();
    GPIO_InitTypeDef led = {0};
    led.Pin = GPIO_PIN_13;
    led.Mode = GPIO_MODE_OUTPUT_PP;
    HAL_GPIO_Init(GPIOC, &led);

    // ะะฝะธัะธะฐะปะธะทะฐัะธั ัะฝะบะพะดะตัะพะฒ
    Encoder_Init();

    uint32_t last_update = 0;

    while (1) {
       // ะะฑะฝะพะฒะปััั RPM ะบะฐะถะดัะต 100ะผั
       if (HAL_GetTick() - last_update >= 100) {
          last_update = HAL_GetTick();
          Encoder_Update();

          // ะะพะปััะธัั RPM ะดะปั ะบะฐะถะดะพะณะพ ะผะพัะพัะฐ
          float rpm0 = Encoder_GetRPM(ENCODER_0);
          float rpm1 = Encoder_GetRPM(ENCODER_1);
          float rpm2 = Encoder_GetRPM(ENCODER_2);
          float rpm3 = Encoder_GetRPM(ENCODER_3);

          // ะัะฒะตััะธ ะฒ ะบะพะฝัะพะปั (ัะตัะตะท UART ะธะปะธ SWO)
          // printf("RPM: M0=%.1f M1=%.1f M2=%.1f M3=%.1f\n",
          //        rpm0, rpm1, rpm2, rpm3);

          // ะะธะณะฐัั LED ะตัะปะธ ะตััั movimento
          if (rpm0 > 10 || rpm1 > 10 || rpm2 > 10 || rpm3 > 10) {
             HAL_GPIO_TogglePin(GPIOC, GPIO_PIN_13);
          }
       }
    }
}
```

---

## ๐ ะะฐััะตั RPM

### ะคะพัะผัะปะฐ

```c
RPM = (ะบะพะปะธัะตััะฒะพ_ะธะผะฟัะปััะพะฒ * 60) / (ะฒัะตะผั_ะฒ_ัะตะบัะฝะดะฐั * ะฟัะพัะตะทั_ะฝะฐ_ะพะฑะตัั)
RPM = (pulse_count * 60) / (time_seconds * 20)
```

### ะัะธะผะตั ัะฐััะตัะฐ

**ะะฐะฝะพ:**

- ะะผะฟัะปััะพะฒ ะทะฐ 0.1 ัะตะบ: 10
- ะัะพัะตะทะพะฒ ะฝะฐ ะดะธัะบะต: 20

**ะะฐััะตั:**

```
RPM = (10 * 60) / (0.1 * 20)
RPM = 600 / 2
RPM = 300
```

**ะัะพะฒะตัะบะฐ:**

- 300 ะพะฑะพัะพัะพะฒ/ะผะธะฝััั
- 300 / 60 = 5 ะพะฑะพัะพัะพะฒ/ัะตะบัะฝะดั
- 5 ะพะฑะพัะพัะพะฒ * 20 ะฟัะพัะตะทะพะฒ = 100 ะธะผะฟัะปััะพะฒ/ัะตะบัะฝะดั
- ะะฐ 0.1 ัะตะบ: 10 ะธะผะฟัะปััะพะฒ โ

### ะ ะบะพะดะต

```c
void Encoder_Update(void) {
    uint32_t current_time = HAL_GetTick();  // ะผั

    for (uint8_t i = 0; i < ENCODER_COUNT; i++) {
       uint32_t pulses = pulse_count[i] - last_count[i];
       uint32_t time_diff_ms = current_time - last_time[i];

       if (time_diff_ms > 0) {
          // ะะตัะตะฒะพะดะธะผ ะฒัะตะผั ะฒ ัะตะบัะฝะดั: time_diff_ms / 1000
          // RPM = (pulses * 60) / ((time_diff_ms / 1000) * 20)
          // RPM = (pulses * 60 * 1000) / (time_diff_ms * 20)
          // RPM = (pulses * 60000) / (time_diff_ms * 20)

          rpm[i] = (pulses * 60000.0f) / (time_diff_ms * ENCODER_SLOTS_PER_REV);
       }

       last_count[i] = pulse_count[i];
       last_time[i] = current_time;
    }
}
```

---

## ๐๏ธ ะะพะฝัะฐะถ ะดะธัะบะฐ ัะฝะบะพะดะตัะฐ

### ะจะฐะณ 1: ะะพะดะณะพัะพะฒะบะฐ ะดะธัะบะฐ

```
    โโโโโโโโโ
    โ   โ   โ  โ ะฆะตะฝััะฐะปัะฝะพะต ะพัะฒะตัััะธะต
    โ /   \ โ     ะดะปั ะพัะธ ะผะพัะพัะฐ
    โ/     \โ
    โโโโโโโโโ
```

1. ะฃะฑะตะดะธัะตัั, ััะพ ะพัะฒะตัััะธะต ะฟะพะดัะพะดะธั ะดะปั ะพัะธ ะผะพัะพัะฐ
2. ะัะธ ะฝะตะพะฑัะพะดะธะผะพััะธ ัะฐััะฒะตัะปะธัะต ะพัะฒะตัััะธะต
3. ะัะธััะธัะต ะดะธัะบ ะพั ะฟัะปะธ

### ะจะฐะณ 2: ะฃััะฐะฝะพะฒะบะฐ ะฝะฐ ะพัั

**ะะฐัะธะฐะฝั ะ: ะก ะฒะธะฝัะพะผ**

```
    ะะธัะบ
     โ
  โโโโโโโโโ
  โ   โ   โ
โโโดโโโโผโโโโดโโ ะัั ะผะพัะพัะฐ
     โ
    ะะธะฝั (M3)
```

**ะะฐัะธะฐะฝั ะ: ะะฐ ะบะปะตะน**

```
  โโโโโโโโโ
  โ ะะปะตะน  โ
  โโโโโฌโโโโ
     โ
โโโโโโโดโโโโโโ ะัั ะผะพัะพัะฐ
```

### ะจะฐะณ 3: ะะพะทะธัะธะพะฝะธัะพะฒะฐะฝะธะต ะดะฐััะธะบะฐ

```
        ะะธัะบ ะฒัะฐัะฐะตััั
            โ
       โโโโโโโโโโโโโ
       โ           โ
       โ           โ
       โโโโโโโฌโโโโโโ
            โ
        โโโโโโดโโโโโ
        โ โโโ โโโ โ  โ ะะฐััะธะบ
        โ โโโ โโโ โ     (ะัะพัะตะท 6ะผะผ)
        โโโดโโดโโดโโดโโ
         โ     โ
        LED  Photo
```

**ะะฐะถะฝะพ:**

1. โ ะะธัะบ ะดะพะปะถะตะฝ ัะฒะพะฑะพะดะฝะพ ะฟัะพัะพะดะธัั ัะตัะตะท ะฟัะพัะตะท (6ะผะผ)
2. โ ะะธัะบ ะะ ะบะฐัะฐะตััั ะดะฐััะธะบะฐ
3. โ ะะฐัััะพัะฝะธะต: 1-2ะผะผ ะทะฐะทะพั
4. โ ะะตะท ะฒะธะฑัะฐัะธะน ะฟัะธ ะฒัะฐัะตะฝะธะธ

### ะจะฐะณ 4: ะขะตััะธัะพะฒะฐะฝะธะต

```c
// ะขะตััะพะฒัะน ะบะพะด
void test_encoder(void) {
    Encoder_Init();

    printf("ะัััะธัะต ะผะพัะพั ะฒัััะฝัั...\n");

    for (int i = 0; i < 50; i++) {
       HAL_Delay(100);
       Encoder_Update();

       uint32_t count = Encoder_GetCount(ENCODER_0);
       float rpm = Encoder_GetRPM(ENCODER_0);

       printf("ะะผะฟัะปััะพะฒ: %lu, RPM: %.1f\n", count, rpm);
    }
}
```

**ะะถะธะดะฐะตะผัะน ัะตะทัะปััะฐั:**

- ะัะธ ะฒัะฐัะตะฝะธะธ: ััะตััะธะบ ัะฒะตะปะธัะธะฒะฐะตััั
- LED ะฝะฐ ะดะฐััะธะบะต ะผะธะณะฐะตั
- RPM ะพัะพะฑัะฐะถะฐะตััั ะบะพััะตะบัะฝะพ

---

## ๐ ะัะฐะบัะธัะตัะบะธะต ะฟัะธะผะตะฝะตะฝะธั

### 1. ะะพะฝััะพะปั ัะบะพัะพััะธ ะผะพัะพัะฐ (PID)

```c
float target_rpm = 300.0f;
float current_rpm = Encoder_GetRPM(ENCODER_0);
float error = target_rpm - current_rpm;

// ะัะพััะพะน P-ัะตะณัะปััะพั
float pwm_duty = base_duty + (error * Kp);
Motor_SetSpeed(MOTOR_0, pwm_duty);
```

### 2. ะะดะพะผะตััะธั (ะธะทะผะตัะตะฝะธะต ัะฐัััะพัะฝะธั)

```c
// ะะธะฐะผะตัั ะบะพะปะตัะฐ: 65ะผะผ
#define WHEEL_DIAMETER_MM  65.0f
#define WHEEL_CIRCUMFERENCE (3.14159f * WHEEL_DIAMETER_MM)

float calculate_distance_mm(uint32_t pulses) {
    // 1 ะพะฑะพัะพั = 20 ะธะผะฟัะปััะพะฒ = ะดะปะธะฝะฐ ะพะบััะถะฝะพััะธ
    float rotations = pulses / 20.0f;
    float distance = rotations * WHEEL_CIRCUMFERENCE;
    return distance;
}
```

### 3. ะกะธะฝััะพะฝะธะทะฐัะธั ะผะพัะพัะพะฒ

```c
void sync_motors(void) {
    float rpm0 = Encoder_GetRPM(ENCODER_0);
    float rpm1 = Encoder_GetRPM(ENCODER_1);

    // ะััะฐะฒะฝะธะฒะฐะฝะธะต ัะบะพัะพััะธ
    if (rpm0 > rpm1 + 5) {
       Motor_AdjustSpeed(MOTOR_0, -2);  // ะะฐะผะตะดะปะธัั
       Motor_AdjustSpeed(MOTOR_1, +2);  // ะฃัะบะพัะธัั
    }
}
```

### 4. ะะตัะตะบัะธัะพะฒะฐะฝะธะต ะพััะฐะฝะพะฒะบะธ

```c
void check_motor_stall(void) {
    float rpm = Encoder_GetRPM(ENCODER_0);
    uint8_t pwm = Motor_GetPWM(MOTOR_0);

    // ะะพัะพั ัะฐะฑะพัะฐะตั, ะฝะพ ัะฝะบะพะดะตั ะฝะต ะดะฒะธะถะตััั
    if (pwm > 30 && rpm < 10) {
       // ะะพัะพั ะทะฐะฑะปะพะบะธัะพะฒะฐะฝ!
       Motor_Stop(MOTOR_0);
       printf("WARNING: Motor 0 stalled!\n");
    }
}
```

---

## ๐ ะะธะฐะณะฝะพััะธะบะฐ ะฟัะพะฑะปะตะผ

### ะัะพะฑะปะตะผะฐ 1: ะกัะตััะธะบ ะฝะต ัะฒะตะปะธัะธะฒะฐะตััั

**ะัะพะฒะตัััะต:**

- โ ะะธัะฐะฝะธะต: VCC = 3.3V, GND ะฟะพะดะบะปััะตะฝ
- โ ะะธัะบ ะฒัะฐัะฐะตััั
- โ ะะธัะบ ะฟัะพัะพะดะธั ัะตัะตะท ะดะฐััะธะบ
- โ LED ะฝะฐ ะดะฐััะธะบะต ะผะธะณะฐะตั ะฟัะธ ะฒัะฐัะตะฝะธะธ
- โ ะัะตััะฒะฐะฝะธั ะฒะบะปััะตะฝั ะฒ ะบะพะดะต

**ะขะตัั LED ะดะฐััะธะบะฐ:**

```c
// ะัััะฝัั ะดะฒะธะณะฐะนัะต ะดะธัะบ ัะตัะตะท ะดะฐััะธะบ
// LED ะดะพะปะถะฝะฐ ะผะธะณะฐัั: ON โ OFF โ ON โ OFF
```

### ะัะพะฑะปะตะผะฐ 2: ะฅะฐะพัะธัะฝัะต ะธะผะฟัะปััั (ััะผ)

**ะะตัะตะฝะธะต:**

1. ะะพะฑะฐะฒะธัั ะฟัะพะณัะฐะผะผะฝะพะต debouncing:

```c
static uint32_t last_pulse_time[ENCODER_COUNT] = {0};

void EXTI_IRQHandler(void) {
    uint32_t now = HAL_GetTick();

    // ะะณะฝะพัะธัะพะฒะฐัั ะธะผะฟัะปััั ัะฐัะต ัะตะผ 1ะผั
    if (now - last_pulse_time[0] > 1) {
       pulse_count[0]++;
       last_pulse_time[0] = now;
    }
}
```

1. ะัะพะฒะตัะธัั ะผะตัะฐะฝะธัะตัะบะพะต ะบัะตะฟะปะตะฝะธะต (ะฒะธะฑัะฐัะธะธ)
2. ะะพะฑะฐะฒะธัั ะบะพะฝะดะตะฝัะฐัะพั 0.1ยตF ะฝะฐ VCC ะดะฐััะธะบะฐ

### ะัะพะฑะปะตะผะฐ 3: RPM ะฝะตะฟัะฐะฒะธะปัะฝัะน

**ะัะพะฒะตัััะต:**

- โ `ENCODER_SLOTS_PER_REV = 20` (ะดะปั ะดะธัะบะฐ ั 20 ะฟัะพัะตะทะฐะผะธ)
- โ `Encoder_Update()` ะฒัะทัะฒะฐะตััั ัะตะณัะปััะฝะพ
- โ ะคะพัะผัะปะฐ ัะฐััะตัะฐ ะบะพััะตะบัะฝะฐ
- โ ะะธัะบ ะฝะต ะฟัะพัะบะฐะปัะทัะฒะฐะตั ะฝะฐ ะพัะธ

**ะขะตัั:**

```c
// ะะพััะธัะฐะนัะต 1 ะฟะพะปะฝัะน ะพะฑะพัะพั ะฒัััะฝัั
// ะะพะปะถะฝะพ ะฑััั ัะพะฒะฝะพ 20 ะธะผะฟัะปััะพะฒ
uint32_t start = Encoder_GetCount(ENCODER_0);
// ... ัะดะตะปะฐะนัะต 1 ะพะฑะพัะพั ...
uint32_t end = Encoder_GetCount(ENCODER_0);
printf("ะะผะฟัะปััะพะฒ ะทะฐ ะพะฑะพัะพั: %lu (ะพะถะธะดะฐะตััั 20)\n", end - start);
```

### ะัะพะฑะปะตะผะฐ 4: ะัะตััะฒะฐะฝะธั ะฝะต ััะฐะฑะพัะฐะปะธ

**ะัะพะฒะตัััะต ะฒ `stm32f4xx_it.c`:**

```c
// ะญัะธ ััะฝะบัะธะธ ะดะพะปะถะฝั ะฑััั ะพะฑััะฒะปะตะฝั:
void EXTI2_IRQHandler(void);
void EXTI3_IRQHandler(void);
void EXTI9_5_IRQHandler(void);
```

**ะัะปะธ ะธั ะฝะตั - ะดะพะฑะฐะฒััะต:**

```c
void EXTI2_IRQHandler(void) {
    extern void EXTI2_IRQHandler(void);
}
// ะะฝะฐะปะพะณะธัะฝะพ ะดะปั ะดััะณะธั
```

---

## ๐ ะะฐะดะฐะฝะธั ะดะปั ะฟัะฐะบัะธะบะธ

### ะะฐะดะฐะฝะธะต 1: ะะฐะทะพะฒะพะต ะธะทะผะตัะตะฝะธะต

1. ะะพะดะบะปััะธัะต 1 ัะฝะบะพะดะตั ะบ ะผะพัะพัั
2. ะัะฒะตะดะธัะต RPM ัะตัะตะท UART ะบะฐะถะดัั ัะตะบัะฝะดั
3. ะกัะฐะฒะฝะธัะต ะธะทะผะตัะตะฝะฝัะน RPM ั ัะตะฐะปัะฝัะผ

### ะะฐะดะฐะฝะธะต 2: ะกัะฐะฑะธะปะธะทะฐัะธั ัะบะพัะพััะธ

1. ะฃััะฐะฝะพะฒะธัะต ัะตะปะตะฒะพะน RPM = 200
2. ะะตะฐะปะธะทัะนัะต P-ัะตะณัะปััะพั ะดะปั ะฟะพะดะดะตัะถะฐะฝะธั ัะบะพัะพััะธ
3. ะัะฒะตะดะธัะต ะณัะฐัะธะบ RPM (ัะตัะตะท Serial Plotter)

### ะะฐะดะฐะฝะธะต 3: ะกะธะฝััะพะฝะธะทะฐัะธั

1. ะะพะดะบะปััะธัะต 2 ัะฝะบะพะดะตัะฐ
2. ะะตะฐะปะธะทัะนัะต ัะธะฝััะพะฝะธะทะฐัะธั ัะบะพัะพััะธ 2 ะผะพัะพัะพะฒ
3. ะะฐะบัะธะผะฐะปัะฝะฐั ัะฐะทะฝะธัะฐ RPM < 5%

### ะะฐะดะฐะฝะธะต 4: ะะดะพะผะตััะธั

1. ะะทะผะตัััะต ะดะธะฐะผะตัั ะบะพะปะตัะฐ
2. ะะตะฐะปะธะทัะนัะต ััะฝะบัะธั ะธะทะผะตัะตะฝะธั ัะฐัััะพัะฝะธั ะฒ ะผะผ
3. ะกะดะตะปะฐะนัะต ัะพะฑะพัะฐ, ะบะพัะพััะน ะฟัะพะตะทะถะฐะตั ัะพะฒะฝะพ 1 ะผะตัั

---

## ๐ ะะพะฟะพะปะฝะธัะตะปัะฝัะต ัะตััััั

### ะะพะบัะผะตะฝัะฐัะธั

- [sensors.md](../memory/sensors.md) - ะะพะปะฝะฐั ัะตัะฝะธัะตัะบะฐั ะดะพะบัะผะตะฝัะฐัะธั ัะฝะบะพะดะตัะพะฒ
- [TB6612FNG_Dual_Connection_Guide.md](TB6612FNG_Dual_Connection_Guide.md) - ะะพะดะบะปััะตะฝะธะต ะผะพัะพัะพะฒ

### ะะพะผะฟะพะฝะตะฝัั

- ะะฐััะธะบ: <https://arduino.ua/prod2290-opticheskii-datchik-prepyatstviya-kompaktnii>
- ะะธัะบ: <https://arduino.ua/prod4271-disk-s-prorezyami-dlya-opticheskogo-enkodera>

### ะกะปะตะดัััะธะน ััะพะบ

- **ะฃัะพะบ 05**: UART ะธ ะฒัะฒะพะด ะดะฐะฝะฝัั ะฒ ัะตัะผะธะฝะฐะป
- **ะฃัะพะบ 06**: PID ัะตะณัะปััะพั ะดะปั ััะฐะฑะธะปะธะทะฐัะธะธ ัะบะพัะพััะธ

---

## โ ะงะตะบะปะธัั ะณะพัะพะฒะฝะพััะธ

ะะตัะตะด ะฟะตัะตัะพะดะพะผ ะบ ัะปะตะดัััะตะผั ััะพะบั ัะฑะตะดะธัะตัั:

- [ ] ะญะฝะบะพะดะตั ะฟะพะดะบะปััะตะฝ ะธ ััะตััะธะบ ัะฐะฑะพัะฐะตั
- [ ] RPM ัะฐัััะธััะฒะฐะตััั ะฟัะฐะฒะธะปัะฝะพ
- [ ] ะัะตััะฒะฐะฝะธั EXTI ะฝะฐัััะพะตะฝั
- [ ] ะะธัะบ ะฒัะฐัะฐะตััั ะฑะตะท ะฒะธะฑัะฐัะธะน
- [ ] LED ะฝะฐ ะดะฐััะธะบะต ะผะธะณะฐะตั ะฟัะธ ะฒัะฐัะตะฝะธะธ
- [ ] ะะพะด ะบะพะผะฟะธะปะธััะตััั ะฑะตะท ะพัะธะฑะพะบ
- [ ] ะะทะผะตัะตะฝะฝัะน RPM ัะพะพัะฒะตัััะฒัะตั ัะตะฐะปัะฝะพะผั

---

**ะะพะทะดัะฐะฒะปัะตะผ! ะขะตะฟะตัั ะฒั ะผะพะถะตัะต ะธะทะผะตัััั ัะบะพัะพััั ะผะพัะพัะพะฒ! ๐**

*ะฃัะพะบ ัะพะทะดะฐะฝ 15.02.2026 ะดะปั ะฟัะพะตะบัะฐ STM32 Black Pill*
